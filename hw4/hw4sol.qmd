---
title: "Biostat 203B Homework 4"
subtitle: "Due Mar 8 @ 11:59PM"
author: "Ziheng Zhang_606300061"
format:
  html:
    theme: cosmo
    embed-resources: true
    number-sections: false
    toc: true
    toc-depth: 4
    toc-location: left
    code-fold: false
execute:
  eval: false
---

Display machine information:
```{r, eval=TRUE}
sessionInfo()
```
Display my machine memory.
```{r, eval=TRUE}
memuse::Sys.meminfo()
```

Load database libraries and the tidyverse frontend:
```{r, eval=TRUE}
library(bigrquery)
library(dbplyr)
library(DBI)
library(gt)
library(gtsummary)
library(tidyverse)
```

## Q1. Compile the ICU cohort in HW3 from the Google BigQuery database 

Below is an outline of steps. In this homework, we exclusively work with the BigQuery database and should not use any MIMIC data files stored on our local computer. Transform data as much as possible in BigQuery database and `collect()` the tibble only at the end of Q1.7.

### Q1.1 Connect to BigQuery

Authenticate with BigQuery using the service account token. Please place the service account token (shared via BruinLearn) in the working directory (same folder as your qmd file). Do **not** add this token to your git repository.
```{r, eval=TRUE}
# path to the service account token 
satoken <- "biostat-203b-2024-winter-313290ce47a6.json"
# BigQuery authentication using service account2
bq_auth(path = satoken)
```
Connect to BigQuery database `mimic4_v2_2` in GCP (Google Cloud Platform), using the project billing account `biostat-203b-2024-winter`.
```{r, eval=TRUE}
# connect to the BigQuery database `biostat-203b-2024-winter.mimic4_v2_2`
con_bq <- dbConnect(
    bigrquery::bigquery(),
    project = "biostat-203b-2024-winter",
    dataset = "mimic4_v2_2",
    billing = "biostat-203b-2024-winter"
)
con_bq
```
List all tables in the `mimic4_v2_2` database.
```{r, eval=TRUE}
dbListTables(con_bq)
```
### Q1.2 `icustays` data

Connect to the `icustays` table.
```{r, eval=TRUE}
# full ICU stays table
icustays_tble <- tbl(con_bq, "icustays") |>
  # show_query() |>
  print(width = Inf)
```

### Q1.3 `admissions` data

Connect to the `admissions` table.
```{r, eval=TRUE}
# # TODO
admissions_tble <- tbl(con_bq, "admissions") |>
  # show_query() |>
  print(width = Inf)
```

### Q1.4 `patients` data

Connect to the `patients` table.
```{r, eval=TRUE}
# # TODO
patients_tble <- tbl(con_bq, "patients") |>
  # show_query() |>
  print(width = Inf)
```

### Q1.5 `labevents` data

Connect to the `labevents` table and retrieve a subset that only contain subjects who appear in `icustays_tble` and the lab items listed in HW3. Only keep the last lab measurements before the ICU stay and pivot lab items to become variables/columns. Write all steps in _one_ chain of pipes.
```{r, eval=TRUE}
# # TODO
labevents_tble <- tbl(con_bq, "labevents") |> 
  filter(itemid %in% c(50912, 50971, 50983, 50902, 
                       50882, 51221, 51301, 50931)) |> 
  select(subject_id, itemid, valuenum, storetime) |>
  
  # filter subject_id in labevents to match with icustays_tble
  semi_join(icustays_tble, by = c("subject_id")) |> 
  
  # combine label names
  left_join(tbl(con_bq, "d_labitems") |> select(itemid, label), 
            by = c("itemid")) |> 
  
   # combine intime and stay_id by subject_id
  left_join(icustays_tble |> select(subject_id, stay_id, intime), 
            by = c("subject_id")) |> 
  
  # filter the measurement before the ICU stay
  filter(storetime < intime) |> 
  group_by(subject_id, label, stay_id) |>
  
  # sort by storetime and get the last available measurement
  arrange(storetime, .by_group = TRUE) |> 
  slice_max(storetime, with_ties = FALSE) |> 
  arrange(subject_id, stay_id, itemid) |> #filter(subject_id == 10171405) |> print(width = Inf)
  select(-storetime, -intime, -itemid) |> 
  ungroup() |>
  mutate(label = tolower(label)) |> 
  
  # temporarily store the result of the query
  compute() |>
  
  # transform the table to wide format
  pivot_wider(names_from = label, values_from = valuenum) |> 
  rename("wbc" = "white blood cells") |>
  print(width = Inf)
```

### Q1.6 `chartevents` data

Connect to `chartevents` table and retrieve a subset that only contain subjects who appear in `icustays_tble` and the chart events listed in HW3. Only keep the first chart events during ICU stay and pivot chart events to become variables/columns. Write all steps in _one_ chain of pipes.
```{r, eval=TRUE}
# # TODO
chartevents_tble <- tbl(con_bq, "chartevents") |>
  filter(itemid %in% c(220045, 220179, 220180, 220210, 223761)) |> 
  select(subject_id, itemid, valuenum, charttime) |>
  semi_join(icustays_tble, by = c("subject_id")) |>
  left_join(tbl(con_bq, "d_items") |> select(itemid, label), 
            by = c("itemid")) |>
  left_join(icustays_tble |> select(subject_id, stay_id, intime, 
                                    outtime), by = c("subject_id")) |>
  filter(charttime >= intime & charttime <= outtime) |>
  group_by(subject_id, label, stay_id) |>
  
  # sort by charttime and get the first available measurement
  arrange(charttime, .by_group = TRUE) |>
  slice_min(charttime, with_ties = FALSE) |>
  arrange(subject_id, stay_id, itemid) |>
  select(-charttime, -intime, -outtime, -itemid) |>
  ungroup() |> 
  compute() |>
  mutate(label = tolower(label)) |>
  mutate(label = gsub(" ", "_", label)) |>
  pivot_wider(names_from = label, values_from = valuenum) |>
  print(width = Inf)

```

### Q1.7 Put things together

This step is similar to Q7 of HW3. Using _one_ chain of pipes `|>` to perform following data wrangling steps: (i) start with the `icustays_tble`, (ii) merge in admissions and patients tables, (iii) keep adults only (age at ICU intime >= 18), (iv) merge in the labevents and chartevents tables, (v) `collect` the tibble.

```{r, eval=TRUE}
# # TODO
mimic_icu_cohort <- icustays_tble |> 
  left_join(admissions_tble, by = c("subject_id", "hadm_id")) |>
  left_join(patients_tble, by = c("subject_id")) |>
  left_join(labevents_tble, by = c("subject_id", "stay_id")) |>
  left_join(chartevents_tble, by = c("subject_id", "stay_id")) |>
  mutate(age_intime = anchor_age + year(intime) - anchor_year) |>
  filter(age_intime >= 18) |>
  collect() |>
  arrange(subject_id, hadm_id) |>
  print(width = Inf)
```

### Q1.8 Preprocessing

Perform the following preprocessing steps. (i) Lump infrequent levels into "Other" level for `first_careunit`, `last_careunit`, `admission_type`, `admission_location`, and `discharge_location`. (ii) Collapse the levels of `race` into `ASIAN`, `BLACK`, `HISPANIC`, `WHITE`d, and `Other`. (iii) Create a new variable `los_long` that is `TRUE` when `los` is greater than or equal to 2 days. (iv) Summarize the data using `tbl_summary()`, stratified by `los_long`. Hint: `fct_lump` and `fct_collapse` from the `forcats` package can be useful.

Hint: Below is a numerical summary of my tibble after preprocessing:

<iframe width=95% height="500" src="./mimic_icu_cohort_gtsummary.html"></iframe>

```{r, eval=TRUE}
# # TODO
mimic_icu_cohort <- mimic_icu_cohort |>
  mutate(
    first_careunit = fct_lump(first_careunit, n = 4),
    last_careunit = fct_lump(last_careunit, n = 4),
    admission_type = fct_lump(admission_type, n = 4),
    admission_location = fct_lump(admission_location, n = 4),
    discharge_location = fct_lump(discharge_location, n = 4)) |>
  mutate(race = fct_collapse(race, 
                             "ASIAN" = str_subset(mimic_icu_cohort$race, 
                                                  "ASIAN"),
                             "BLACK" = str_subset(mimic_icu_cohort$race, 
                                                  "BLACK"),
                             "HISPANIC" = str_subset(mimic_icu_cohort$race, 
                                                     "HISPANIC"),
                             "WHITE" = str_subset(mimic_icu_cohort$race, 
                                                  "WHITE"), 
                             other_level = "OTHER")) |>
  mutate(los_long = los >= 2)


tbl_summary(mimic_icu_cohort, by = los_long, 
            include = -c(subject_id, hadm_id, stay_id, intime, outtime, 
                         admittime, dischtime, deathtime, admit_provider_id, 
                         edregtime, edouttime, anchor_age, anchor_year, 
                         anchor_year_group))
```

### Q1.9 Save the final tibble

Save the final tibble to an R data file `mimic_icu_cohort.rds` in the `mimiciv_shiny` folder.
```{r}
# make a directory mimiciv_shiny
if (!dir.exists("mimiciv_shiny")) {
  dir.create("mimiciv_shiny")
}
# save the final tibble
mimic_icu_cohort |>
  write_rds("mimiciv_shiny/mimic_icu_cohort.rds", compress = "gz")
```
Close database connection and clear workspace.
```{r}
if (exists("con_bq")) {
  dbDisconnect(con_bq)
}
rm(list = ls())
```
Although it is not a good practice to add big data files to git, for grading purpose, please add `mimic_icu_cohort.rds` to your git repository.

## Q2. Shiny app

Develop a Shiny app for exploring the ICU cohort data created in Q1. The app should reside in the `mimiciv_shiny` folder. The app should contains at least two tabs. One tab provides easy access to the graphical and numerical summaries of variables (demographics, lab measurements, vitals) in the ICU cohort. The other allows user to choose a specific patient in the cohort and display the patient's ADT and ICU stay information as we did in Q1 of HW3.

**Answer:** The code for the Shiny app is in the folder `mimiciv_shiny`.

```{r, eval=FALSE}
mimic <- readRDS("./mimic_icu_cohort.rds") |>
  mutate(race = as_factor(race), insurance = as_factor(insurance),
         marital_status = as_factor(marital_status), gender = as_factor(gender))

# create a new shiny ui
mimic_ui <- fluidPage(
  
  # application title
  titlePanel("MIMIC-IV ICU Cohort Explorer"), 
  
  # create tabs
  tabsetPanel(
    
    # first tab
    tabPanel("Overall Data Summary", 
             
             # Sidebar layout with input and output definitions
             sidebarLayout(
               
               # Sidebar panel for inputs
               sidebarPanel(
                 
                 # Input: Text for providing a caption 
                 textInput(inputId = "caption", 
                           label = "Caption:", 
                           value = "Data Summary"),
                 
                 # Input: choose a dataset (first level category)
                 selectInput(inputId = "dataset", 
                             label = "Choose a dataset:",
                             choices = c("demographics", "lab measurements", 
                                         "vitals")),
                 
                 # Input: choose a variable (second level category)
                 conditionalPanel(
                   condition = "input.dataset == 'demographics'",
                   selectInput(inputId = "demo_summary",
                               label = "Choose a demographics variable:",
                               choices = c("race", "insurance", "marital_status", 
                                           "gender", "age_intime"))),
                 
                 # Input: choose a variable (second level category)
                 conditionalPanel(
                   condition = "input.dataset == 'lab measurements'",
                   selectInput(inputId = "lab_summary",
                               label = "Choose a lab variable:",
                               choices = c("bicarbonate", "chloride", 
                                           "creatinine", "glucose", 
                                           "potassium", "sodium", 
                                           "hematocrit", "wbc"))),
                 
                 # Input: choose a variable (second level category)
                 conditionalPanel(
                   condition = "input.dataset == 'vitals'",
                   selectInput(inputId = "vital_summary",
                               label = "Choose a vital variable:",
                               choices = c("heart_rate", 
                                           "non_invasive_blood_pressure_systolic", 
                                           "non_invasive_blood_pressure_diastolic", 
                                           "respiratory_rate", 
                                           "temperature_fahrenheit"))),
                 
                 # Input: Slider for the limit of x-axis
                 uiOutput("xlimit"),
               ),
               
               # Main panel for displaying outputs
               mainPanel(
                 
                 # Output: Formatted text for caption
                 h3(textOutput("caption", container = span)),
                 
                 # Output: Verbatim text for data summary
                 verbatimTextOutput("summary"),
                 
                 # Output: plot of the data
                 plotOutput(outputId = "sumPlot")
               )
             )
    ),
    
    # second tab
    tabPanel("Patient Information", 
             
             # Sidebar layout with input and output definitions
             sidebarLayout(
               
               # Sidebar panel for inputs
               sidebarPanel(
                 
                 # Input: Selector for choosing a patient
                 textInput(inputId = "patient_id", 
                           label = "Patient ID:", 
                           value = ""),
                 
                 # Input: Selector for choosing a type of information
                 selectInput(inputId = "info_type",
                             label = "Choose a type of information:",
                             choices = c("ADT", "ICU stay"))
               ),
               
               # Main panel for displaying outputs
               mainPanel(
                 
                 # Output: Formatted text for caption
                 h3(textOutput("patient_id", container = span)),
                 
                 # Output: plot of the data
                 plotOutput(outputId = "idPlot")
               )
             )
    )
  )
)




mimic_server <- function(input, output, session) {
  
  # create ractive data
  filtered_data <- reactive({
    switch(input$dataset, 
           "demographics" = mimic[, input$demo_summary],
           "lab measurements" = mimic[, input$lab_summary],
           "vitals" = mimic[, input$vital_summary])
  })
  
  # render the caption
  output$caption <- renderText({
    input$caption
  })
  
  # render the numerical summary
  output$summary <- renderPrint({
    summary(filtered_data())
  })
  
  # render the graphical summary
  output$sumPlot <- renderPlot({
    data <- filtered_data()
    
    if (is.factor(data[[colnames(data)]])) {
      
      # draw a bar plot if it is a categorical variable
      ggplot(data, aes_string(x = colnames(data), fill = colnames(data))) + 
        geom_bar() +
        labs(title = colnames(data)) +
        theme(axis.text.x = element_blank()) +
        theme_bw()
    } else {
      
      # draw a histogram if it is a continuous variable
      ggplot(data, aes_string(x = colnames(data))) + 
        geom_histogram(binwidth = 1, fill = "salmon", color = "black") +
        labs(title = colnames(data)) +
        xlim(input$xlimit) +
        theme_bw()
    }
  })
  
  # render the slider
  output$xlimit <- renderUI({
    data <- filtered_data()
    if (is.numeric(data[[colnames(data)]])) {
      sliderInput(inputId = "xlimit",
                  label = "Limit of x-axis:",
                  min = min(data, na.rm = TRUE),
                  max = max(data, na.rm = TRUE),
                  value = c(min(data, na.rm = TRUE),
                            max(data, na.rm = TRUE)))
    }
  })
  
  # render the patient id
  output$patient_id <- renderText({
    paste0("Patient ", input$patient_id, " Information")
  })
  
  # # render the patient plot
  # output$idPlot <- renderPlot({
  #   if (input$patient_id %in% mimic$subject_id) {
  #     if (input$info_type == "ADT") {
  #       patient_id <- input$patient_id # set patient ID
  #       
  #       # find race for that patient
  #       race_info <- mimic |> 
  #         filter(subject_id == patient_id) |>
  #         select(subject_id, race)
  # 
  #       # find other personal info for that patient
  #       personal_info <- mimic |>
  #         filter(subject_id == patient_id) |>
  #         select(subject_id, gender, anchor_age) |>
  #         rename(age = anchor_age) |>
  #         left_join(race_info, by = "subject_id") |>
  #         distinct()
  # 
  #       # find top 3 diagnoses for that patient in each stay ID
  #       diagonose_code_info <- read_csv("~/mimic/hosp/d_icd_diagnoses.csv.gz")
  #       diagnose_info <- read_csv("~/mimic/hosp/diagnoses_icd.csv.gz") |>
  #         filter(subject_id == patient_id) |>
  #         select(-icd_version) |>
  #         filter(seq_num <= 3) |>
  #         left_join(diagonose_code_info, by = "icd_code") |>
  #         select(-icd_version)
  # 
  #       # find ADT info for that patient
  #       ADT_info <- read_csv("~/mimic/hosp/transfers.csv.gz") |>
  #         filter(subject_id == patient_id) |>
  #         select(subject_id, hadm_id, intime, outtime, eventtype, careunit) |>
  #         filter(eventtype != "discharge") |>
  #         arrange(intime) |>
  #         distinct()
  # 
  #       # find lab info for that patient
  #       lab_info <- open_dataset("./labevents_pq", format = "parquet") |>
  #         filter(subject_id == patient_id) |>
  #         select(subject_id, hadm_id, charttime) |>
  #         collect() |>
  #         distinct()
  # 
  #       # find procedure info for that patient
  #       procedure_code_info <- read_csv("~/mimic/hosp/d_icd_procedures.csv.gz")
  #       procedure_info <- read_csv("~/mimic/hosp/procedures_icd.csv.gz") |>
  #         filter(subject_id == patient_id) |>
  #         select(subject_id, hadm_id, chartdate, icd_code) |>
  #         mutate(chartdate = as.POSIXct(chartdate, 
  #                                       format = "%Y-%m-%d %H:%M:%S")) |>
  #         left_join(procedure_code_info, by = "icd_code") |>
  #         select(-icd_version) |>
  #         arrange(chartdate) |> 
  #         
  #         # split long title and only keep the first part
  #         mutate(short_title = str_split(long_title, ",") %>% sapply(function(x) 
  #           x[1])) |> 
  #         distinct()
  # 
  #       # combine personal info into required format
  #       title_text <- sprintf("Patient %d, %s, %d years old, %s", 
  #                             personal_info$subject_id, personal_info$gender, 
  #                             personal_info$age, tolower(personal_info$race))
  # 
  #       top3_text <- diagnose_info |>
  #         slice(1:3) |>
  #         select(long_title) |>
  #         mutate(first_five_words = str_split(long_title, "\\s+") %>% 
  #                  sapply(function(x) {
  #                    if (length(x) < 5) {
  #                      
  #                      # in case some diagnosis has less than 5 words
  #                      paste(x, collapse = " ") 
  #                      } else {
  #                        paste(x[1:5], collapse = " ")
  #                        }
  #                    })) |> 
  #         pull(first_five_words)
  # 
  #       subtitle_text <- sprintf("%s\n%s\n%s", top3_text[1], top3_text[2], 
  #                                top3_text[3])
  # 
  #       # create the plot and y-axis
  #       empty_plot <- ggplot() + 
  #         geom_blank() +
  #         scale_y_discrete(limits = c("Procedure", "Lab", "ADT")) +
  #         labs(x = "Calendar Time", title = title_text, 
  #              subtitle = tolower(subtitle_text)) +
  #         theme_bw()
  # 
  #       ADT_plot <- empty_plot + 
  #         geom_segment(data = ADT_info, aes(x = intime, xend = outtime, 
  #                                           y = "ADT", yend = "ADT", 
  #                                           color = careunit), 
  #                      linewidth = ifelse(str_detect(ADT_info$careunit, "CCU") | 
  #                                           str_detect(ADT_info$careunit, 
  #                                                      "ICU"), 8, 3)) + 
  #         labs(color = "Care Unit") +
  #         theme(legend.position = "bottom", legend.box = "vertical", 
  #               text = element_text(size = 8))
  # 
  #       Lab_plot <- ADT_plot + 
  #         geom_point(data = lab_info, aes(x = charttime, y = "Lab"), 
  #                    size = 5, shape = "+")
  # 
  #       Procedure_plot <- Lab_plot + 
  #         geom_point(data = procedure_info, aes(x = chartdate, y = "Procedure", 
  #                                               shape = short_title), 
  #                    size = 5) +
  # 
  #         # set manually the shape of the procedure to be the total 9 procedures
  #         scale_shape_manual(values = 
  #                              seq(1, length(
  #                                unique(procedure_info$short_title)))) + 
  #         labs(shape = "Procedure", y = "") + 
  #         guides(shape = guide_legend(nrow = 5)) + 
  #         theme(legend.position = "bottom", legend.box = "vertical", 
  #               text = element_text(size = 8))
  # 
  #       plot(Procedure_plot)
  #       
  #       } else {
  #         
  #         patient_id <- input$patient_id
  #         
  #         item_icu_info <- read_csv("~/mimic/icu/d_items.csv.gz") |>
  #           filter(itemid %in% c(220045, 220180, 220179, 220210, 223761)) |>
  #           select(itemid, abbreviation) |>
  #           distinct()
  # 
  #         chartevents_info <- open_dataset("./chartevents_pq", 
  #                                          format = "parquet") |>
  #           filter(subject_id == patient_id) |>
  #           filter(itemid %in% c(220045, 220180, 220179, 220210, 223761)) |>
  #           select(subject_id, stay_id, itemid, charttime, valuenum) |>
  #           collect() |>
  #           left_join(item_icu_info, by = "itemid") |>
  #           mutate(charttime = with_tz(charttime, "UTC"))
  # 
  #         title_text <- sprintf("Patient %d ICU stays - Vitals", 
  #                               chartevents_info$subject_id)
  # 
  #         icu_plot <- ggplot(chartevents_info, aes(x = charttime, y = valuenum, 
  #                                                  color = abbreviation)) +
  #           geom_point(size = 1) +
  #           geom_line() +
  #           labs(title = title_text, 
  #                x = "", 
  #                y = "") + 
  #           facet_grid(rows = vars(abbreviation), cols = vars(stay_id), 
  #                      scales = "free") +
  #           theme_light() +
  #           theme(legend.position = "none") +
  #           scale_x_datetime(date_labels = "%b %d %H:%M") +
  #           
  #           # to avoid overlapping of x-axis labels
  #           guides(x = guide_axis(n.dodge = 2)) 
  # 
  #         plot(icu_plot)
  #         }
  #     } else {
  #       return("Please enter a valid Patient ID.")
  #       }
  # 
  # })
}

shinyApp(mimic_ui, mimic_server)


```


```{r, eval=FALSE}
mimic <- readRDS("mimiciv_shiny/mimic_icu_cohort.rds") |>
  mutate(race = as_factor(race), insurance = as_factor(insurance),
         marital_status = as_factor(marital_status), gender = as_factor(gender))

# create a new shiny ui
mimic_ui <- fluidPage(
  
  # application title
  titlePanel("MIMIC-IV ICU Cohort Explorer"), 
  
  # create tabs
  tabsetPanel(
    
    # first tab
    tabPanel("Overall Data Summary", 
             
      # Sidebar layout with input and output definitions
      sidebarLayout(

        # Sidebar panel for inputs
        sidebarPanel(

          # Input: Text for providing a caption 
          textInput(inputId = "caption", 
                    label = "Caption:", 
                    value = "Data Summary"),

          # Input: Selector for choosing dataset ----
          selectInput(inputId = "dataset", 
                      label = "Choose a dataset:",
                      choices = c("demographics", "lab measurements", 
                                  "vitals")),

          # Input: Type of summary to view ----
          selectInput(inputId = "type",
                      label = "Choose a type:",
                      choices = c("graphical", "numerical"))
        ),

        # Main panel for displaying outputs
        mainPanel(

          # Output: Formatted text for caption
          h3(textOutput("caption", container = span)),

          # Output: Verbatim text for data summary
          verbatimTextOutput("summary"),

          # Output: plot of the data
          plotOutput(outputId = "sumPlot")
        )
      )
    ),
    
    # second tab
    tabPanel("Patient Information", 
             
      # Sidebar layout with input and output definitions
      sidebarLayout(
        
        # Sidebar panel for inputs
        sidebarPanel(
          
          # Input: Selector for choosing a patient
          textInput(inputId = "patient_id", 
                    label = "Patient ID:", 
                    value = ""),
          
          # Input: Selector for choosing a type of information
          selectInput(inputId = "info_type",
                      label = "Choose a type of information:",
                      choices = c("ADT", "ICU stay"))
        ),
        
        # Main panel for displaying outputs
        mainPanel(
          
          # Output: Formatted text for caption
          h3(textOutput("patient_id", container = span)),
          
          # Output: plot of the data
          plotOutput(outputId = "idPlot")
        )
      )
    )
  )
)
  
  
 

mimic_server <- function(input, output) {
  
  # render the caption
  output$caption <- renderText({
    input$caption
  })
  
  # render the numerical summary
  output$summary <- renderPrint({
    data <- switch(input$dataset, 
                   "demographics" = mimic[, c("race", "insurance", 
                                              "marital_status", "gender", 
                                              "age_intime")],
                   "lab measurements" = mimic[, c("bicarbonate", "chloride", 
                                                  "creatinine", "glucose", 
                                                  "potassium", "sodium", 
                                                  "hematocrit", "wbc")],
                   "vitals" = mimic[, c("heart_rate", 
                                        "non_invasive_blood_pressure_systolic", 
                                        "non_invasive_blood_pressure_diastolic", 
                                        "respiratory_rate", 
                                        "temperature_fahrenheit")])
    if (input$type == "numerical") {
      summary(data)
      } else {
        return()  
        }
  })
  
  # render the graphical summary
  output$sumPlot <- renderPlot({
    data <- switch(input$dataset, 
                   "demographics" = mimic[, c("race", "insurance", 
                                              "marital_status", "gender", 
                                              "age_intime")],
                   "lab measurements" = mimic[, c("bicarbonate", "chloride", 
                                                  "creatinine", "glucose", 
                                                  "potassium", "sodium", 
                                                  "hematocrit", "wbc")],
                   "vitals" = mimic[, c("heart_rate", 
                                        "non_invasive_blood_pressure_systolic", 
                                        "non_invasive_blood_pressure_diastolic", 
                                        "respiratory_rate", 
                                        "temperature_fahrenheit")])
    
    if (input$type == "graphical") {
      plots <- list()
      for (col in colnames(data)) {
        if (is.factor(data[[col]])) {
          
          # draw a bar plot if it is a categorical variable
          plot <- ggplot(data, aes_string(x = col, fill = col)) + 
            geom_bar() +
            labs(title = col) +
            theme(axis.text.x = element_blank())
        } else {
          # draw a histogram if it is a continuous variable
          plot <- ggplot(data, aes_string(x = col)) + 
            geom_histogram(binwidth = 1, fill = "salmon", color = "black") +
            labs(title = col)
        }
        plots[[col]] <- plot
        }
      
      # put the plots in a grid
      grid.arrange(grobs = plots, ncol = 2)
      } else {
        return(NULL)  
        }
    
  })
  
  # render the patient id
  output$patient_id <- renderText({
    input$patient_id
  })
  
  # render the patient plot
  output$idPlot <- renderPlot({
    if (input$patient_id %in% mimic$subject_id) {
      if (input$info_type == "ADT") {
        patient_id <- input$patient_id # set patient ID
        
        # find race for that patient
        race_info <- mimic |> 
          filter(subject_id == patient_id) |>
          select(subject_id, race)

        # find other personal info for that patient
        personal_info <- mimic |>
          filter(subject_id == patient_id) |>
          select(subject_id, gender, anchor_age) |>
          rename(age = anchor_age) |>
          left_join(race_info, by = "subject_id") |>
          distinct()

        # find top 3 diagnoses for that patient in each stay ID
        diagonose_code_info <- read_csv("~/mimic/hosp/d_icd_diagnoses.csv.gz")
        diagnose_info <- read_csv("~/mimic/hosp/diagnoses_icd.csv.gz") |>
          filter(subject_id == patient_id) |>
          select(-icd_version) |>
          filter(seq_num <= 3) |>
          left_join(diagonose_code_info, by = "icd_code") |>
          select(-icd_version)

        # find ADT info for that patient
        ADT_info <- read_csv("~/mimic/hosp/transfers.csv.gz") |>
          filter(subject_id == patient_id) |>
          select(subject_id, hadm_id, intime, outtime, eventtype, careunit) |>
          filter(eventtype != "discharge") |>
          arrange(intime) |>
          distinct()

        # find lab info for that patient
        lab_info <- open_dataset("./labevents_pq", format = "parquet") |>
          filter(subject_id == patient_id) |>
          select(subject_id, hadm_id, charttime) |>
          collect() |>
          distinct()
  
        # find procedure info for that patient
        procedure_code_info <- read_csv("~/mimic/hosp/d_icd_procedures.csv.gz")
        procedure_info <- read_csv("~/mimic/hosp/procedures_icd.csv.gz") |>
          filter(subject_id == patient_id) |>
          select(subject_id, hadm_id, chartdate, icd_code) |>
          mutate(chartdate = as.POSIXct(chartdate, 
                                        format = "%Y-%m-%d %H:%M:%S")) |>
          left_join(procedure_code_info, by = "icd_code") |>
          select(-icd_version) |>
          arrange(chartdate) |> 
          
          # split long title and only keep the first part
          mutate(short_title = str_split(long_title, ",") %>% sapply(function(x) 
            x[1])) |> 
          distinct()

        # combine personal info into required format
        title_text <- sprintf("Patient %d, %s, %d years old, %s", 
                              personal_info$subject_id, personal_info$gender, 
                              personal_info$age, tolower(personal_info$race))

        top3_text <- diagnose_info |>
          slice(1:3) |>
          select(long_title) |>
          mutate(first_five_words = str_split(long_title, "\\s+") %>% 
                   sapply(function(x) {
                     if (length(x) < 5) {
                       
                       # in case some diagnosis has less than 5 words
                       paste(x, collapse = " ") 
                       } else {
                         paste(x[1:5], collapse = " ")
                         }
                     })) |> 
          pull(first_five_words)

        subtitle_text <- sprintf("%s\n%s\n%s", top3_text[1], top3_text[2], 
                                 top3_text[3])

        # create the plot and y-axis
        empty_plot <- ggplot() + 
          geom_blank() +
          scale_y_discrete(limits = c("Procedure", "Lab", "ADT")) +
          labs(x = "Calendar Time", title = title_text, 
               subtitle = tolower(subtitle_text)) +
          theme_bw()

        ADT_plot <- empty_plot + 
          geom_segment(data = ADT_info, aes(x = intime, xend = outtime, 
                                            y = "ADT", yend = "ADT", 
                                            color = careunit), 
                       linewidth = ifelse(str_detect(ADT_info$careunit, "CCU") | 
                                            str_detect(ADT_info$careunit, 
                                                       "ICU"), 8, 3)) + 
          labs(color = "Care Unit") +
          theme(legend.position = "bottom", legend.box = "vertical", 
                text = element_text(size = 8))

        Lab_plot <- ADT_plot + 
          geom_point(data = lab_info, aes(x = charttime, y = "Lab"), 
                     size = 5, shape = "+")

        Procedure_plot <- Lab_plot + 
          geom_point(data = procedure_info, aes(x = chartdate, y = "Procedure", 
                                                shape = short_title), 
                     size = 5) +
  
          # set manually the shape of the procedure to be the total 9 procedures
          scale_shape_manual(values = 
                               seq(1, length(
                                 unique(procedure_info$short_title)))) + 
          labs(shape = "Procedure", y = "") + 
          guides(shape = guide_legend(nrow = 5)) + 
          theme(legend.position = "bottom", legend.box = "vertical", 
                text = element_text(size = 8))

        plot(Procedure_plot)
        
        } else {
          
          patient_id <- input$patient_id
          
          item_icu_info <- read_csv("~/mimic/icu/d_items.csv.gz") |>
            filter(itemid %in% c(220045, 220180, 220179, 220210, 223761)) |>
            select(itemid, abbreviation) |>
            distinct()

          chartevents_info <- open_dataset("./chartevents_pq", 
                                           format = "parquet") |>
            filter(subject_id == patient_id) |>
            filter(itemid %in% c(220045, 220180, 220179, 220210, 223761)) |>
            select(subject_id, stay_id, itemid, charttime, valuenum) |>
            collect() |>
            left_join(item_icu_info, by = "itemid") |>
            mutate(charttime = with_tz(charttime, "UTC"))

          title_text <- sprintf("Patient %d ICU stays - Vitals", 
                                chartevents_info$subject_id)

          icu_plot <- ggplot(chartevents_info, aes(x = charttime, y = valuenum, 
                                                   color = abbreviation)) +
            geom_point(size = 1) +
            geom_line() +
            labs(title = title_text, 
                 x = "", 
                 y = "") + 
            facet_grid(rows = vars(abbreviation), cols = vars(stay_id), 
                       scales = "free") +
            theme_light() +
            theme(legend.position = "none") +
            scale_x_datetime(date_labels = "%b %d %H:%M") +
            
            # to avoid overlapping of x-axis labels
            guides(x = guide_axis(n.dodge = 2)) 

          plot(icu_plot)
          }
      } else {
        return("Please enter a valid Patient ID.")
        }

  })
}

shinyApp(mimic_ui, mimic_server)

# save the shiny app to a directory
saveAppDir(
  appDir = "mimiciv_shiny",
  appname = "mimic_icu_app",
  overwrite = TRUE
)
```



